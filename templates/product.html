{% extends 'dashboard.html' %}
{% block title %}{% endblock %}
{% block content %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, msg in messages %}
          <div class="{{ 'form-success' if category == 'success' else 'form-error' }}">
            {{ msg }}
            <span class="close-btn material-icons">close</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="product-grid">
    {% if products %}
      {% for product in products %}
        <div class="product-card">
          <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-image">
          <h3>{{ product.name }}</h3>
          <p>Price: {{ product.price }} RWF</p>
          <p>Category: {{ product.category }}</p>
          <p>Unit: {{ product.selling_unit }}</p>
          <p>Market: {{ product.market.marketplace }}</p>
          <div class="action-buttons">
            <a href="{{ url_for('update_product', id=product.id) }}" class="action-button update">
              <span class="material-icons">edit</span> Update
            </a>
            <button class="action-button delete" data-id="{{ product.id }}" onclick="openModal(this)">
              <span class="material-icons">delete</span> Delete
            </button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No products yet.</p>
    {% endif %}
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete this product?</p>
      <div class="modal-actions">
        <button class="cta-button cancel-btn" onclick="closeModal()">Cancel</button>
        <form id="deleteForm" method="POST" style="display: none;">
          <input type="hidden" name="product_id" id="deleteProductId">
        </form>
        <button class="cta-button delete-confirm-btn" onclick="submitDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const navLinks = document.querySelectorAll('.sidebar-links a, .bottom-nav .nav-links a');
      navLinks.forEach(link => {
        if (link.getAttribute('href') === '/dashboard') {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });

      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.parentElement.style.opacity = '0';
          setTimeout(() => this.parentElement.remove(), 300);
        });
      });
    });

    function openModal(el) {
      const productId = el.getAttribute('data-id');
      document.getElementById('deleteProductId').value = productId;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    function submitDelete() {
      const form = document.getElementById('deleteForm');
      form.action = `/delete/${document.getElementById('deleteProductId').value}`;
      form.submit();
    }

    window.addEventListener('click', function(event) {
      const modal = document.getElementById('confirmModal');
      if (event.target === modal) {
        closeModal();
      }
    });
  </script>
{% endblock %}